name: Update AdGuard DNS Domain List

permissions:
  contents: write

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download AdGuard DNS filter
      run: |
        curl -s https://filters.adtidy.org/dns/filter_1_ios.txt -o filter_raw.txt

    - name: Convert to clean Shadowrocket format
      run: |
        > adguard_domain_suffix.txt

        grep '^||' filter_raw.txt \
        | sed 's/^||//' \
        | sed 's/\^.*//' \
        | sed 's/\/.*//' \
        | tr -d '\r' \
        | while read line; do

            # пропускаем пустые
            if [ -z "$line" ]; then
              continue
            fi

            # если есть wildcard
            if echo "$line" | grep -q '\*'; then

              # если внутри есть нормальный домен
              domain=$(echo "$line" | grep -oE '[A-Za-z0-9.-]+\.[A-Za-z]{2,}' | head -n1)

              if [ -n "$domain" ]; then
                # проверка что не начинается с точки или дефиса
                if ! echo "$domain" | grep -Eq '^[-.]'; then
                  echo "DOMAIN-SUFFIX,$domain"
                fi
              else
                # fallback → keyword
                keyword=$(echo "$line" | tr -d '*')
                keyword=$(echo "$keyword" | sed 's/^[.-]*//; s/[.-]*$//')

                if echo "$keyword" | grep -Eq '[A-Za-z0-9]{4,}'; then
                  echo "DOMAIN-KEYWORD,$keyword"
                fi
              fi

            else
              # без wildcard → проверяем валидный домен
              if echo "$line" | grep -Eq '^[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'; then
                if ! echo "$line" | grep -Eq '^[-.]'; then
                  echo "DOMAIN-SUFFIX,$line"
                fi
              fi
            fi

        done | sort -u >> adguard_domain_suffix.txt

        rm -f filter_raw.txt

    - name: Commit and push if changed
      env:
        REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        git add adguard_domain_suffix.txt

        if git diff --cached --quiet; then
          echo "No changes detected"
        else
          git commit -m "Auto update AdGuard DNS list $(date -u +'%Y-%m-%d')"
          git push "https://x-access-token:${REPO_TOKEN}@github.com/${{ github.repository }}.git"
        fi
