name: Update Shadowrocket Mobile Ads Rules

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/update-mobile-ads-rules.yml'

jobs:
  convert-rules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download AdGuard Mobile Ads filter
        run: |
          curl -o adguard_mobile_ads.txt https://filters.adtidy.org/ios/filters/2_optimized.txt

      - name: Convert to Shadowrocket format
        run: |
          python3 << 'EOF'
          import re
          from datetime import datetime

          def convert_adguard_to_shadowrocket(input_file, output_file):

              # Список исключений
              whitelist = {
                  'ozon.ru',
              }

              def is_ip_address(s):
                  """Проверяет, является ли строка IP-адресом"""
                  parts = s.split('.')
                  if len(parts) != 4:
                      return False
                  try:
                      return all(0 <= int(part) <= 255 for part in parts)
                  except ValueError:
                      return False

              def is_whitelisted(domain):
                  """Проверяет домен и все его родительские домены на вхождение в whitelist"""
                  if domain in whitelist:
                      return True
                  for white in whitelist:
                      if domain.endswith('.' + white):
                          return True
                  return False

              def extract_domain(line):
                  """Извлекает домен из правила AdGuard, возвращает (тип, домен) или None"""

                  # Пропускаем правила-исключения (@@), они разрешают трафик
                  if line.startswith('@@'):
                      return None

                  # Пропускаем CSS/JS правила (содержат ## или #@#)
                  if '##' in line or '#@#' in line or '#$#' in line:
                      return None

                  # Пропускаем регулярные выражения
                  if line.startswith('/') and line.endswith('/'):
                      return None

                  # Пропускаем правила только для определённых сайтов (содержат запятую перед ##)
                  if re.match(r'^[^|*]+##', line):
                      return None

                  # Убираем модификаторы после $
                  if '$' in line:
                      # Пропускаем правила с модификатором document (блокировка страниц целиком)
                      if '$document' in line or '$redirect' in line:
                          return None
                      line = line.split('$')[0]

                  # Пропускаем правила с wildcards
                  if '*' in line:
                      match = re.search(r'\*\.([a-zA-Z0-9][a-zA-Z0-9\-]*\.[a-zA-Z0-9][a-zA-Z0-9\-\.]*[a-zA-Z0-9])\^?', line)
                      if match:
                          domain = match.group(1).strip('.')
                          if domain and '.' in domain and '*' not in domain:
                              parts = domain.split('.')
                              if len(parts[-2]) > 3 and not is_ip_address(domain) and not is_whitelisted(domain):
                                  return ('DOMAIN-SUFFIX', domain)
                      return None

                  # ||example.com^ — блокировка домена и поддоменов
                  if line.startswith('||'):
                      match = re.match(r'\|\|([^/\^$\*]+)', line)
                      if match:
                          domain = match.group(1).strip('.')
                          if domain and '/' not in domain and '*' not in domain and not is_whitelisted(domain):
                              if is_ip_address(domain):
                                  return ('IP-CIDR', domain)
                              else:
                                  return ('DOMAIN-SUFFIX', domain)

                  # |example.com^ — точное совпадение домена
                  elif line.startswith('|') and not line.startswith('||'):
                      match = re.match(r'\|([^/\^$\*]+)', line)
                      if match:
                          domain = match.group(1).strip('.')
                          if domain and '/' not in domain and '*' not in domain and not is_whitelisted(domain):
                              if is_ip_address(domain):
                                  return ('IP-CIDR', domain)
                              else:
                                  return ('DOMAIN', domain)

                  return None

              shadowrocket_rules = []
              shadowrocket_rules.append(f"# Shadowrocket Mobile Ads Rules")
              shadowrocket_rules.append(f"# Converted from AdGuard Mobile Ads filter (iOS)")
              shadowrocket_rules.append(f"# Last updated: {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')} UTC")
              shadowrocket_rules.append(f"# Source: https://filters.adtidy.org/ios/filters/2_optimized.txt")
              shadowrocket_rules.append("")

              with open(input_file, 'r', encoding='utf-8') as f:
                  for line in f:
                      line = line.strip()

                      if not line or line.startswith('!') or line.startswith('#'):
                          continue

                      result = extract_domain(line)
                      if result:
                          rule_type, domain = result
                          if rule_type == 'IP-CIDR':
                              shadowrocket_rules.append(f"IP-CIDR,{domain}/32")
                          elif rule_type == 'DOMAIN-SUFFIX':
                              shadowrocket_rules.append(f"DOMAIN-SUFFIX,{domain}")
                          elif rule_type == 'DOMAIN':
                              shadowrocket_rules.append(f"DOMAIN,{domain}")

              # Удаляем дубликаты, сохраняя порядок
              seen = set()
              unique_rules = []
              for rule in shadowrocket_rules:
                  if rule not in seen:
                      seen.add(rule)
                      unique_rules.append(rule)

              with open(output_file, 'w', encoding='utf-8') as f:
                  f.write('\n'.join(unique_rules))

              print(f"Converted rules: {len(unique_rules) - 5}")
              print(f"File saved: {output_file}")

          convert_adguard_to_shadowrocket('adguard_mobile_ads.txt', 'shadowrocket_mobile_ads.conf')
          EOF

      - name: Check if there are changes
        id: changes
        run: |
          git add shadowrocket_mobile_ads.conf
          git diff --cached --quiet || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push if changed
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "Update Mobile Ads rules - $(date +'%Y-%m-%d %H:%M:%S UTC')"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: shadowrocket-mobile-ads-rules
          path: shadowrocket_mobile_ads.conf
          retention-days: 30
