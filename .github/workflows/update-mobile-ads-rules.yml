name: Update Shadowrocket Mobile Ads Rules

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/update-mobile-ads-rules.yml'

jobs:
  convert-rules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download AdGuard filter
        run: |
          curl -o adguard_mobile_ads.txt https://filters.adtidy.org/ios/filters/15_optimized.txt

      - name: Convert to Shadowrocket format
        run: |
          python3 << 'EOF'
          import re
          import os
          from datetime import datetime

          def convert_adguard_to_shadowrocket(input_file, output_file, existing_rules_file):

              # Список исключений
              whitelist = {
                  'ozon.ru',
                  'ozone.ru',
                  'amazonaws.com',
                  'aliyuncs.com',
              }

              def is_ip_address(s):
                  parts = s.split('.')
                  if len(parts) != 4:
                      return False
                  try:
                      return all(0 <= int(part) <= 255 for part in parts)
                  except ValueError:
                      return False

              def is_whitelisted(domain):
                  if domain in whitelist:
                      return True
                  for white in whitelist:
                      if domain.endswith('.' + white):
                          return True
                  return False

              def is_duplicate(domain):
                  if domain in existing_domains:
                      return True
                  parts = domain.split('.')
                  for i in range(1, len(parts)):
                      parent = '.'.join(parts[i:])
                      if parent in existing_domains:
                          return True
                  return False

              def extract_domain(line):
                  if line.startswith('@@'):
                      return None
                  if '##' in line or '#@#' in line or '#$#' in line:
                      return None
                  if line.startswith('/') and line.endswith('/'):
                      return None
                  if re.match(r'^[^|*]+##', line):
                      return None
                  if '$' in line:
                      if '$document' in line or '$redirect' in line:
                          return None
                      line = line.split('$')[0]

                  if '*' in line:
                      match = re.search(r'\*\.([a-zA-Z0-9][a-zA-Z0-9\-]*\.[a-zA-Z0-9][a-zA-Z0-9\-\.]*[a-zA-Z0-9])\^?', line)
                      if match:
                          domain = match.group(1).strip('.')
                          if domain and '.' in domain and '*' not in domain:
                              parts = domain.split('.')
                              if len(parts[-2]) > 3 and not is_ip_address(domain):
                                  return ('DOMAIN-SUFFIX', domain)
                      return None

                  if line.startswith('||'):
                      match = re.match(r'\|\|([^/\^$\*]+)', line)
                      if match:
                          domain = match.group(1).strip('.')
                          if domain and '/' not in domain and '*' not in domain:
                              if is_ip_address(domain):
                                  return ('IP-CIDR', domain)
                              else:
                                  return ('DOMAIN-SUFFIX', domain)

                  elif line.startswith('|') and not line.startswith('||'):
                      match = re.match(r'\|([^/\^$\*]+)', line)
                      if match:
                          domain = match.group(1).strip('.')
                          if domain and '/' not in domain and '*' not in domain:
                              if is_ip_address(domain):
                                  return ('IP-CIDR', domain)
                              else:
                                  return ('DOMAIN', domain)

                  return None

              # Загружаем существующие правила из первого списка
              existing_domains = set()
              if os.path.exists(existing_rules_file):
                  with open(existing_rules_file, 'r', encoding='utf-8') as f:
                      for line in f:
                          line = line.strip()
                          if line.startswith('DOMAIN-SUFFIX,'):
                              existing_domains.add(line.replace('DOMAIN-SUFFIX,', ''))
                          elif line.startswith('DOMAIN,'):
                              existing_domains.add(line.replace('DOMAIN,', ''))
                          elif line.startswith('IP-CIDR,'):
                              existing_domains.add(line.replace('IP-CIDR,', '').replace('/32', ''))
                  print(f"Loaded {len(existing_domains)} existing rules from {existing_rules_file}")

              shadowrocket_rules = []
              shadowrocket_rules.append(f"# Shadowrocket Mobile Ads Rules")
              shadowrocket_rules.append(f"# Converted from AdGuard filter (iOS)")
              shadowrocket_rules.append(f"# Last updated: {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')} UTC")
              shadowrocket_rules.append(f"# Source: https://filters.adtidy.org/ios/filters/15_optimized.txt")
              shadowrocket_rules.append("")

              skipped_whitelist = 0
              skipped_duplicate = 0
              added = 0

              with open(input_file, 'r', encoding='utf-8') as f:
                  for line in f:
                      line = line.strip()
                      if not line or line.startswith('!') or line.startswith('#'):
                          continue

                      result = extract_domain(line)
                      if not result:
                          continue

                      rule_type, domain = result

                      if is_whitelisted(domain):
                          skipped_whitelist += 1
                          continue

                      if is_duplicate(domain):
                          skipped_duplicate += 1
                          continue

                      if rule_type == 'IP-CIDR':
                          shadowrocket_rules.append(f"IP-CIDR,{domain}/32")
                      elif rule_type == 'DOMAIN-SUFFIX':
                          shadowrocket_rules.append(f"DOMAIN-SUFFIX,{domain}")
                      elif rule_type == 'DOMAIN':
                          shadowrocket_rules.append(f"DOMAIN,{domain}")

                      added += 1

              seen = set()
              unique_rules = []
              for rule in shadowrocket_rules:
                  if rule not in seen:
                      seen.add(rule)
                      unique_rules.append(rule)

              with open(output_file, 'w', encoding='utf-8') as f:
                  f.write('\n'.join(unique_rules))

              print(f"Added:             {added}")
              print(f"Skipped duplicate: {skipped_duplicate}")
              print(f"Skipped whitelist: {skipped_whitelist}")
              print(f"File saved:        {output_file}")

          convert_adguard_to_shadowrocket(
              'adguard_mobile_ads.txt',
              'shadowrocket_mobile_ads.conf',
              'shadowrocket_rules.conf'
          )
          EOF

      - name: Check if there are changes
        id: changes
        run: |
          git add shadowrocket_mobile_ads.conf
          git diff --cached --quiet || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push if changed
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "Update Mobile Ads rules - $(date +'%Y-%m-%d %H:%M:%S UTC')"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: shadowrocket-mobile-ads-rules
          path: shadowrocket_mobile_ads.conf
          retention-days: 30
